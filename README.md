CBCanarias web
=========

A responsive web system based in [AngularJS](https://angularjs.org/), [Material design](https://material.angularjs.org),
[Foundation](https://circlingthesun.github.io/angular-foundation-6/) and [MongoDB](www.mongodb.com).

The web and it's content and structure are encapsulated from one another.
The structure is bulilt from a `_src` folder using `kramdown`, and the CSS is built using `SASS`.

Installation
------------

Copy `config.json.example` and name it `config.json`, then change the values inside to match your setup.

```shell
bash ./build.sh
```

### Dependencies

The whole system has a few dependencies:

- **Git**
- **Bower**

   [Bower](https://bower.io/) and [Git](https://git-scm.com/) are needed to install dependencies and keep the web up-to-date.

- **Uglyfyjs**
- **Sass**

   [Uglyfyjs](https://github.com/mishoo/UglifyJS) and [Sass](http://sass-lang.com/) are used to build `_site` folder 
   with minified content, and to create `style.min.css` wich holds all css rules.

- **kramdown**

   [kramdown](https://kramdown.gettalong.org/) is necessary to process the 
   [Markdown](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet) files and their 
   [YAML](http://yaml.org/) headers inside `_src` folder.

- **Ruby**

   [Ruby](www.ruby-lang.org) is also necessary for the previous step, and also to be executed as CGI scripts in `API` and 
   `locales` folders.

- **MongoDB**

   Lastly, [MongoDB](www.mongodb.com) is used to store and retrieve the content of the web, via ruby CGIs.

### Folder structure

- **api**

   Holds the web interface for setting and retrieving information.

- **assets**

   Holds htm templates to be included via AngularJS.

- **bower_components**

   Standard Bower folder holding packaged dependencies.

- **fonts**

   Standard fonts folder to be downloaded and used by CSS.

- **img**

   Standard images folder for files not relating to MongoDB content.

- **js**

   Javascript files relating to the webapp behaviour.

- **locales**

   Dictionaries with key-value pairs and access to MongoDB. One for each language.

- **_sass**

   Sass files with style definitions, modularized.

- **_site**

   Generated folder via `build.sh` holding a “ready to serve” version of the web.
   It will have a copy inside of every folder and file that doesn't begin with an
   underscore (_) or a dot (.).

- **_src**

   A tree structure, where each `node.md` file represents a point in the webapp.

### Managing content

The `_src` folder is a representation of the webapp as folders and files. The 
system compiles the contents of this folder in a JSON structure inside `tree.js` 
using the `make.rb` script when `build.sh` is executed, but if you just want to 
update this file you may call it by hand.

Every page in the webapp has a parent page all the way up to the root (main) 
page. Every folder and subfolder **must** have a `node.md` file.

The node file is a Markdown file with a YAML header. Anything after the header 
will be stored inside the `content` atribute of the node, and compiled as HTML 
by AngularJS `$compile` directive, allowing the use of directives as well as 
standard HTML or Markdown.

The rest of attributes inside the YAML header will be stored as attributes of 
the resulting node object, allowing to pass arbitrary data to the web system, 
but some of the attributes are special and required for the proper functioning 
of the webapp. These special attributes are the following:

- **id**

   This will be used as part of the URL, and should be unique among it's 
   siblings.

- **title**

   The key used to translate the title in the translating dictionary.

- **href**

   If unset, this will be autogenerated based on this node's id as well as all 
   it's ancestors. If set, will be untouched, allowing for hard linking of other 
   nodes or links outside of the webapp.

- **parent**

   This attribute can't be set by hand and will be overwritten if done. It holds 
   a reference to this node's parent node. It's null in the root node.

- **nodes**

   This attribute can't be set by hand and will be overwritten if done. It holds 
   an array with all the child nodes, sorted by folder name.

- **depth**

   This attribute can't be set by hand and will be overwritten if done. It holds 
   an int representing how deep in the tree is the current node.

- **filter**

   This attribute holds a MongoDB query object used by the CGI to know what to 
   retrieve.

- **language**

   This attribute holds a boolean that specify if the query should only retrieve 
   elements from the MongoDB that matches the current language.

- **values**

   This attribute can't be set by hand and will be overwritten if done. It will 
   hold the contents of **values_list**, or **values_view** if the webapp has an 
   int as the last parameter of the path (when viewing a Mongo element, mostly).

- **values_list**

   An array with the attributes we want from the Mongo elements we're 
   retrieving. If none is specified, or if it's an empty array, **all will be 
   fetched**. This attribute is used when listing various elements.

- **values_view**

   An array with the attributes we want from the Mongo elements we're 
   retrieving. If none is specified, or if it's an empty array, **all will be 
   fetched**. This attribute is used when viewing a single element (when the 
   last parameter of the path is an id).

- **offset**

   The number of elements to skip in a list. It can be specified by hand, but 
   has no use in doing so. Please don't overwrite if you don't know exactly what 
   you're doing.

- **limit**

   The number of elements to show in a list page. The webapp will paginate 
   acordingly.

- **view**

   The view directive to be used instead of `content` when viewing an element
   (when the last parameter of the path is an id).  

   Currently it can be `default`, `activity`, `descriptive`, `documental` or
   `hotel`.

If the `content` attribute of a node is empty, it will be considered an empty 
node, made to contain other nodes, and as such it will auto-navigate to it's 
first child and repeat the process. It will also deactivate it's crumb in the 
breadcrumbs bar.

The other attributes are inherited if not found in the current node. This allow 
to define all common attributes in an empty node, and then the differences 
inside each child node.

Imagine as an example a “Where to stay” page. All the subnodes use the same 
`view`, `limit`, `values_list` and `values_view`, and only really differ in 
`id`, `title` and `filter`. Then we can put the first ones inside the parent 
empty node, and it's child nodes will inherit those attributes. Then, we write 
the custom attributes in the child nodes.
